<meta name='viewport' content='width=device-width, initial-scale=1'/>
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Survey Link Generator</title>
<style>
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #121212;
        color: #f0f0f0;
    }
    .container {
        max-width: 1200px;
        margin: 0 auto;
        background: #1e1e1e;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    h1 {
        text-align: center;
        font-size: 24px;
        margin-bottom: 20px;
        color: #ffcc00;
    }
    .file-section {
        text-align: center;
        margin: 20px 0;
        padding: 20px;
        border: 2px dashed #444;
        border-radius: 8px;
        background-color: #222;
    }
    input[type="file"] {
        margin-top: 10px;
    }
    .button-group {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin: 20px 0;
        flex-wrap: wrap;
    }
    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.3s;
    }
    .btn-primary { background-color: #007bff; color: white; }
    .btn-primary:hover { background-color: #0056b3; }
    .btn-success { background-color: #28a745; color: white; }
    .btn-success:hover { background-color: #218838; }
    .btn-warning { background-color: #ffc107; color: #212529; }
    .btn-warning:hover { background-color: #e0a800; }
    .btn:disabled { background-color: #6c757d; cursor: not-allowed; opacity: 0.6; }
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }
    th, td {
        border: 1px solid #333;
        padding: 8px;
        text-align: left;
        vertical-align: middle;
    }
    th {
        background-color: #ff6600;
        color: white;
        position: sticky;
        top: 0;
    }
    tr:nth-child(even) { background-color: #1a1a1a; }
    .copy-btn {
        background-color: #17a2b8;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        white-space: nowrap;
    }
    .copy-btn:hover { background-color: #138496; }
    .copy-btn.copied {
        background-color: red !important;
        cursor: not-allowed;
    }
    /* Hide Survey Model and Generated Link columns visually */
    th:nth-child(3), td:nth-child(3),
    th:nth-child(4), td:nth-child(4) {
        display: none;
    }
    .status {
        text-align: center;
        margin: 20px 0;
        padding: 10px;
        border-radius: 5px;
    }
    .status.success { background-color: #155724; color: #d4edda; border: 1px solid #28a745; }
    .status.error { background-color: #721c24; color: #f8d7da; border: 1px solid #dc3545; }
    .table-container {
        max-height: 600px;
        overflow-y: auto;
        border: 1px solid #333;
        border-radius: 5px;
    }
</style>
</head>
<body>
<div class="container">
    <h1>Survey Link Generator</h1>
    <div class="file-section">
        <h3>Upload Excel File</h3>
        <input type="file" id="fileInput" accept=".xlsx, .xls">
        <div class="button-group">
            <button class="btn btn-primary" id="generateBtn" onclick="processFile()" disabled>Generate Links</button>
            <button class="btn btn-warning" onclick="clearData()">Clear All</button>
        </div>
    </div>
    <div id="status" class="status" style="display: none;"></div>
    <div class="button-group">
        <button class="btn btn-success" id="copyAllBtn" onclick="copyAllLinks()" disabled>Copy All Links</button>
        <button class="btn btn-primary" onclick="exportToCSV()" id="exportBtn" disabled>Export to CSV</button>
    </div>
    <div class="table-container">
        <table id="linkTable">
            <thead>
                <tr>
                    <th>Receipt No.</th>
                    <th>Sales Type</th>
                    <th>Survey Model</th>
                    <th>Generated Link</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
let currentData = [];
const storeID = "91KDIPL571-01";

// Excel date/time converters
function convertExcelDate(serial) {
    const date = new Date((serial - 25569) * 86400 * 1000);
    return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
}
function convertExcelTime(serial) {
    const totalMilliseconds = Math.round(serial * 24 * 60 * 60 * 1000);
    const hours = String(Math.floor(totalMilliseconds / (60 * 60 * 1000))).padStart(2,'0');
    const minutes = String(Math.floor((totalMilliseconds % (60 * 60 * 1000)) / (60 * 1000))).padStart(2,'0');
    const seconds = String(Math.floor((totalMilliseconds % (60 * 1000)) / 1000)).padStart(2,'0');
    const milliseconds = String(totalMilliseconds % 1000).padStart(3,'0');
    return `${hours}:${minutes}:${seconds}.${milliseconds}`;
}

// Generate link
function generateSurveyLink(row) {
    const receiptNo = row['Receipt No.'];
    const salesType = row['Sales Type'];
    let surveyModel = '', orderID = '', numericOT = '';

    if (/^\d+$/.test(receiptNo) && salesType === 'TAKEAWAY') { surveyModel = '6.0'; orderID = receiptNo; numericOT = '2'; }
    else if (/^\d+$/.test(receiptNo) && salesType === 'DINE-IN') { surveyModel = '6.0'; orderID = receiptNo; numericOT = '1'; }
    else if (receiptNo.startsWith('K252') && salesType === 'TAKEAWAY') { surveyModel = '4.0'; orderID = receiptNo.slice(-4); numericOT = '2'; }
    else if (receiptNo.startsWith('K252') && salesType === 'DINE-IN') { surveyModel = '4.0'; orderID = receiptNo.slice(-4); numericOT = '1'; }
    else if (receiptNo.startsWith('K252') && salesType === 'DELIVERY') { surveyModel = '3.0'; orderID = receiptNo; numericOT = '3'; }
    else { return null; }

    const date = convertExcelDate(row['Date']);
    const time = convertExcelTime(row['Time']);
    const phoneNumber = `91${row['Sell-to Contact No.']}`;
    const isoDateTime = `${date}T${time}Z`;

    const data = { "S": storeID, "OI": orderID, "D": date, "TM": time, "DTM": isoDateTime, "TI": orderID, "OT": numericOT, "SM": surveyModel, "PH": phoneNumber };
    const encodedData = btoa(JSON.stringify(data));
    return `https://customer.kfc-listens.com/jfe/form/SV_8bHC0noyvM3jPWC?Q_EED=${encodedData}`;
}

// File processing
function processFile() {
    const file = document.getElementById('fileInput').files[0];
    if (!file) return showStatus('Please select a file first', 'error');
    showStatus('Processing file...', 'success');

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
            const sheetData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            const filteredData = sheetData.filter(row => !(row['POS Receipt No.']||'').match(/K482SWG|K482ZMT|K482MAGIC/));

            currentData = [];
            const tbody = document.querySelector('#linkTable tbody');
            tbody.innerHTML = '';

            let processedCount = 0;
            filteredData.forEach(row => {
                const link = generateSurveyLink(row);
                if (link) {
                    processedCount++;
                    const linkData = {
                        receiptNo: row['Receipt No.'],
                        salesType: row['Sales Type'],
                        surveyModel: link.includes('SM=6.0') ? '6.0' : link.includes('SM=4.0') ? '4.0' : link.includes('SM=3.0') ? '3.0' : 'Unknown',
                        link: link
                    };
                    currentData.push(linkData);

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${linkData.receiptNo}</td>
                        <td>${linkData.salesType}</td>
                        <td>${linkData.surveyModel}</td>
                        <td>${linkData.link}</td>
                        <td><button class="copy-btn" onclick="copyIndividualLink('${link}', this)">Copy</button></td>
                    `;
                    tbody.appendChild(tr);
                }
            });

            showStatus(`Processed ${processedCount} records`, 'success');
            document.getElementById('copyAllBtn').disabled = false;
            document.getElementById('exportBtn').disabled = false;
        } catch (err) {
            showStatus('Error: ' + err.message, 'error');
        }
    };
    reader.readAsArrayBuffer(file);
}

// Copy link
function copyIndividualLink(link, btn) {
    navigator.clipboard.writeText(link).then(() => {
        btn.textContent = 'Copied!';
        btn.classList.add('copied');
        btn.disabled = true;
    });
}

// Copy all
function copyAllLinks() {
    const links = currentData.map(d => d.link).join('\n');
    navigator.clipboard.writeText(links).then(() => {
        showStatus(`Copied ${currentData.length} links`, 'success');
    });
}

// Export CSV
function exportToCSV() {
    const csv = [
        ['Receipt No.', 'Sales Type', 'Survey Model', 'Generated Link'].join(','),
        ...currentData.map(d => [`"${d.receiptNo}"`, `"${d.salesType}"`, `"${d.surveyModel}"`, `"${d.link}"`].join(','))
    ].join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'survey_links.csv';
    a.click();
}

// Clear data
function clearData() {
    currentData = [];
    document.querySelector('#linkTable tbody').innerHTML = '';
    document.getElementById('fileInput').value = '';
    document.getElementById('generateBtn').disabled = true;
    document.getElementById('copyAllBtn').disabled = true;
    document.getElementById('exportBtn').disabled = true;
    clearStatus();
}

// Status
function showStatus(msg, type) {
    const statusDiv = document.getElementById('status');
    statusDiv.textContent = msg;
    statusDiv.className = `status ${type}`;
    statusDiv.style.display = 'block';
}
function clearStatus() {
    document.getElementById('status').style.display = 'none';
}

// Enable generate button
document.getElementById('fileInput').addEventListener('change', e => {
    document.getElementById('generateBtn').disabled = !e.target.files.length;
});
</script>
</body>
</html>
